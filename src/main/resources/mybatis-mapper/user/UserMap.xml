<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.diden.demo.user.UserMapper">
    <resultMap id="userVo" type="com.diden.demo.user.UserVo">
        <result column="USER_GENDER" property="userGender"
                typeHandler="com.diden.demo.user.UserGenderConverterHandler"/>
        <result column="USER_PRIVACY_CONSENT" property="userPrivacyConsent"
                typeHandler="com.diden.demo.user.UserPrivacyConsentConverterHandler"/>
    </resultMap>

    <select id="emailDuplicateCheck" resultType="boolean">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail}
    </select>

    <select id="existsUserEmail" resultType="boolean">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail}
    </select>

    <select id="pageable" resultMap="userVo">
        SELECT USER_NAME,
               USER_PASSWORD,
               USER_NICKNAME,
               USER_GENDER,
               USER_BIRTHDAY,
               USER_EMAIL,
               USER_PHONE_NUMBER,
               USER_CREATE_DATE,
               USER_UPDATE_DATE,
               USER_PRIVACY_CONSENT,
               USER_LOGIN_TYPE,
               USER_REFRESH_TOKEN,
               USER_ACCESS_TOKEN,
               USER_ID
        FROM TB_USER OFFSET #{rowStartNumber} ROWS FETCH NEXT #{rowLimitNumber} + 1 ROWS ONLY
    </select>

    <select id="userList" resultMap="userVo">
        SELECT USER_ID
             , USER_NAME
             , USER_PASSWORD
             , USER_NICKNAME
             , USER_BIRTHDAY
             , USER_GENDER
             , USER_EMAIL
             , USER_PHONE_NUMBER
             , USER_CREATE_DATE
             , USER_UPDATE_DATE
             , USER_PRIVACY_CONSENT
             , USER_LOGIN_TYPE
             , USER_REFRESH_TOKEN
             , USER_ACCESS_TOKEN
        FROM TB_USER
    </select>

    <select id="userInfo" parameterType="com.diden.demo.user.UserVo" resultMap="userVo">
        SELECT USER_ID
             , USER_NAME
             , USER_PASSWORD
             , USER_NICKNAME
             , USER_BIRTHDAY
             , USER_GENDER
             , USER_EMAIL
             , USER_PHONE_NUMBER
             , USER_CREATE_DATE
             , USER_UPDATE_DATE
             , USER_PRIVACY_CONSENT
             , USER_LOGIN_TYPE
             , USER_REFRESH_TOKEN
             , USER_ACCESS_TOKEN
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail}
          AND USER_PASSWORD = #{userPassword}
    </select>

    <select id="findEmailByUser" resultMap="userVo">
        SELECT USER_ID
             , USER_NAME
             , USER_PASSWORD
             , USER_NICKNAME
             , USER_BIRTHDAY
             , USER_GENDER
             , USER_EMAIL
             , USER_PHONE_NUMBER
             , USER_CREATE_DATE
             , USER_UPDATE_DATE
             , USER_PRIVACY_CONSENT
             , USER_LOGIN_TYPE
             , USER_REFRESH_TOKEN
             , USER_ACCESS_TOKEN
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail}
    </select>

    <select id="userRefreshTokenInfo" parameterType="com.diden.demo.user.UserVo"
            resultMap="userVo">
        SELECT USER_ID
             , USER_NAME
             , USER_PASSWORD
             , USER_NICKNAME
             , USER_BIRTHDAY
             , USER_GENDER
             , USER_EMAIL
             , USER_PHONE_NUMBER
             , USER_CREATE_DATE
             , USER_UPDATE_DATE
             , USER_PRIVACY_CONSENT
             , USER_LOGIN_TYPE
             , USER_REFRESH_TOKEN
             , USER_ACCESS_TOKEN
        FROM TB_USER
        WHERE USER_REFRESH_TOKEN = #{userRefreshToken}
    </select>

    <select id="userCount" parameterType="com.diden.demo.user.UserVo" resultType="_integer">
        SELECT COUNT(*)
        FROM TB_USER
        <where>
            AND USER_REFRESH_TOKEN = #{userRefreshToken}
        </where>
    </select>

    <select id="userCheck" parameterType="com.diden.demo.user.UserVo" resultType="_integer">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail}
          AND USER_PASSWORD = #{userPassword}
    </select>

    <insert id="userInsert" parameterType="com.diden.demo.user.UserVo">
        INSERT INTO TB_USER ( USER_PASSWORD
                            , USER_NICKNAME
                            , USER_BIRTHDAY
                            , USER_GENDER
                            , USER_EMAIL
                            , USER_PHONE_NUMBER
                            , USER_PRIVACY_CONSENT
                            , USER_LOGIN_TYPE
                            , USER_REFRESH_TOKEN
                            , USER_ACCESS_TOKEN)
        VALUES ( #{userPassword}
               , #{userNickname}
               , #{userBirthday}
               , #{userGender.gender}
               , #{userEmail}
               , #{userPhoneNumber}
               , #{userPrivacyConsent.choice}
               , #{userLoginType}
               , #{userRefreshToken}
               , #{userAccessToken})
    </insert>

    <update id="userUpdate" parameterType="com.diden.demo.user.UserVo">
        UPDATE tb_user
        SET USER_PASSWORD        = #{userPassword}
          , USER_NICKNAME        = #{userNickname}
          , USER_BIRTHDAY        = #{userBirthday}
          , USER_GENDER          = #{userGender.gender}
          , USER_EMAIL           = #{userEmail}
          , USER_PHONE_NUMBER    = #{userPhoneNumber}
          , USER_PRIVACY_CONSENT = #{userPrivacyConsent.choice}
          , USER_UPDATE_DATE     = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE USER_EMAIL = #{userEmail}
    </update>

    <update id="userTokenUpdate" parameterType="com.diden.demo.user.UserVo">
        UPDATE tb_user
        SET USER_REFRESH_TOKEN = #{userRefreshToken},
            USER_ACCESS_TOKEN  = #{userAccessToken}
        WHERE USER_EMAIL = #{userEmail}
    </update>

    <delete id="userDelete" parameterType="com.diden.demo.user.UserVo">
        DELETE
        FROM TB_USER
        WHERE USER_EMAIL = #{userId}
          AND USER_PASSWORD = #{userPassword}
    </delete>

    <select id="findByLoginType" resultType="String">
        SELECT user_login_type
        FROM tb_user
        WHERE user_access_token = #{authorization}
    </select>

</mapper>